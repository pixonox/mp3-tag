<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced ID3v2 Metadata Editor</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsmediatags for READING metadata -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.7/jsmediatags.min.js"></script>
    
    <!-- id3-writer for WRITING metadata -->
    <script src="https://cdn.jsdelivr.net/npm/id3-writer@1.2.1/dist/id3-writer.min.js"></script>

    <style>
        /* Custom font and scrollbar for a polished look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .drag-over {
            border-color: #38bdf8;
            background-color: #0c4a6e;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-white mb-2">
                <span class="text-sky-400">ID3v2</span> Metadata Editor
            </h1>
            <p class="text-slate-400 text-lg">Edit and save music metadata directly in your browser.</p>
        </header>

        <main class="bg-slate-800 rounded-2xl shadow-2xl shadow-slate-900/50 border border-slate-700">
            
            <!-- File Upload Section -->
            <div id="fileUpload" class="p-8 text-center border-4 border-dashed border-slate-600 rounded-2xl cursor-pointer transition-all duration-300 hover:border-sky-500 hover:bg-slate-700/50">
                <div class="flex flex-col items-center justify-center">
                    <svg class="w-16 h-16 text-slate-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" /></svg>
                    <p class="text-xl font-semibold text-white">Drop your music file here or click to browse</p>
                    <p class="text-slate-400 mt-1">Supports MP3 files for reading and writing tags.</p>
                </div>
                <input type="file" id="fileInput" class="hidden" accept=".mp3">
            </div>

            <!-- Editor Section (hidden by default) -->
            <div id="editorSection" class="hidden p-4 sm:p-8">
                
                <!-- File Info -->
                <div id="fileInfo" class="bg-slate-700/50 p-4 rounded-lg mb-6 border-l-4 border-sky-500"></div>

                <!-- Metadata Form Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Basic Info -->
                    <div class="field-group"><label for="title" class="form-label">Title</label><input type="text" id="title" class="form-input" placeholder="Song Title"></div>
                    <div class="field-group"><label for="artist" class="form-label">Artist</label><input type="text" id="artist" class="form-input" placeholder="Artist Name"></div>
                    <div class="field-group"><label for="album" class="form-label">Album</label><input type="text" id="album" class="form-input" placeholder="Album Title"></div>
                    
                    <!-- Detailed Info -->
                    <div class="field-group"><label for="albumArtist" class="form-label">Album Artist</label><input type="text" id="albumArtist" class="form-input" placeholder="Album Artist"></div>
                    <div class="field-group"><label for="year" class="form-label">Year</label><input type="number" id="year" class="form-input" placeholder="e.g., 2024"></div>
                    <div class="field-group"><label for="track" class="form-label">Track Number</label><input type="text" id="track" class="form-input" placeholder="e.g., 1/12 or 1"></div>
                    <div class="field-group"><label for="genre" class="form-label">Genre</label><input type="text" id="genre" class="form-input" placeholder="e.g., Rock"></div>
                    <div class="field-group"><label for="composer" class="form-label">Composer</label><input type="text" id="composer" class="form-input" placeholder="Composer Name"></div>
                    
                    <!-- Album Artwork -->
                    <div class="field-group md:col-span-2 lg:col-span-3 bg-slate-900/50 p-4 rounded-lg">
                        <label class="form-label">Album Artwork</label>
                        <div class="mt-2 flex items-start gap-4">
                            <div id="artworkPreview" class="w-32 h-32 bg-slate-700 rounded-md flex-shrink-0 flex items-center justify-center">
                                <svg class="w-12 h-12 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            </div>
                            <div class="flex-grow">
                                <div id="artworkInfo" class="text-sm text-slate-400 mb-2">No artwork loaded.</div>
                                <label for="artworkInput" class="btn btn-secondary cursor-pointer">
                                    <span>Upload Image</span>
                                    <input type="file" id="artworkInput" class="hidden" accept="image/jpeg,image/png">
                                </label>
                                <button id="removeArtworkBtn" class="btn btn-danger ml-2 hidden">Remove</button>
                            </div>
                        </div>
                    </div>

                    <!-- Comments -->
                    <div class="field-group md:col-span-2 lg:col-span-3">
                        <label for="comment" class="form-label">Comments</label>
                        <textarea id="comment" class="form-input" rows="3" placeholder="Additional comments or notes"></textarea>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4 justify-center border-t border-slate-700 pt-6">
                    <button id="reloadMetadataBtn" class="btn btn-secondary">üîÑ Reload Original</button>
                    <button id="saveMetadataBtn" class="btn btn-primary">üíæ Save to File</button>
                    <button id="clearAllBtn" class="btn btn-danger">üóëÔ∏è Clear Fields</button>
                </div>

                <!-- Status Message -->
                <div id="statusMessage" class="mt-6 text-center"></div>
            </div>
        </main>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 id="modalTitle" class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p id="modalMessage" class="text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="modalCancelBtn" class="btn btn-secondary">Cancel</button>
                <button id="modalConfirmBtn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/70 flex flex-col items-center justify-center z-50 hidden">
        <div class="w-16 h-16 border-4 border-sky-400 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-white text-lg mt-4">Saving file...</p>
    </div>

    <!-- Tailwind CSS Class Definitions for Dynamic Classes -->
    <script>
        // This helper function applies Tailwind classes to form elements
        function applyTailwindStyles() {
            const formLabelClasses = 'block text-sm font-medium text-slate-400 mb-1';
            const formInputClasses = 'w-full bg-slate-700/50 border-2 border-slate-600 rounded-md p-2.5 text-slate-200 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition';
            const btnClasses = 'inline-flex items-center justify-center px-5 py-2.5 rounded-md font-semibold text-sm shadow-sm transition-all duration-200';
            const btnPrimaryClasses = 'bg-sky-500 text-white hover:bg-sky-600 focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-sky-500';
            const btnSecondaryClasses = 'bg-slate-600 text-slate-200 hover:bg-slate-500 focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-slate-500';
            const btnDangerClasses = 'bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-red-500';

            document.querySelectorAll('.form-label').forEach(el => el.className = formLabelClasses);
            document.querySelectorAll('.form-input').forEach(el => el.className = formInputClasses);
            document.querySelectorAll('.btn').forEach(el => el.classList.add(...btnClasses.split(' ')));
            document.querySelectorAll('.btn-primary').forEach(el => el.classList.add(...btnPrimaryClasses.split(' ')));
            document.querySelectorAll('.btn-secondary').forEach(el => el.classList.add(...btnSecondaryClasses.split(' ')));
            document.querySelectorAll('.btn-danger').forEach(el => el.classList.add(...btnDangerClasses.split(' ')));
        }
        applyTailwindStyles();
    </script>

    <script>
        // --- DOM Element References ---
        const dom = {
            fileUpload: document.getElementById('fileUpload'),
            fileInput: document.getElementById('fileInput'),
            editorSection: document.getElementById('editorSection'),
            fileInfo: document.getElementById('fileInfo'),
            artworkPreview: document.getElementById('artworkPreview'),
            artworkInfo: document.getElementById('artworkInfo'),
            artworkInput: document.getElementById('artworkInput'),
            removeArtworkBtn: document.getElementById('removeArtworkBtn'),
            statusMessage: document.getElementById('statusMessage'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            // Modals
            confirmModal: document.getElementById('confirmModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalMessage: document.getElementById('modalMessage'),
            modalCancelBtn: document.getElementById('modalCancelBtn'),
            modalConfirmBtn: document.getElementById('modalConfirmBtn'),
            // Buttons
            reloadMetadataBtn: document.getElementById('reloadMetadataBtn'),
            saveMetadataBtn: document.getElementById('saveMetadataBtn'),
            clearAllBtn: document.getElementById('clearAllBtn'),
            // Form Fields
            fields: {
                title: document.getElementById('title'),
                artist: document.getElementById('artist'),
                album: document.getElementById('album'),
                albumArtist: document.getElementById('albumArtist'),
                year: document.getElementById('year'),
                track: document.getElementById('track'),
                genre: document.getElementById('genre'),
                composer: document.getElementById('composer'),
                comment: document.getElementById('comment'),
            }
        };

        // --- State Management ---
        let state = {
            currentFile: null,
            currentArtworkFile: null,
            originalMetadata: {},
        };

        // --- Event Listeners ---
        function setupEventListeners() {
            dom.fileUpload.addEventListener('click', () => dom.fileInput.click());
            dom.fileUpload.addEventListener('dragover', handleDragOver);
            dom.fileUpload.addEventListener('dragleave', handleDragLeave);
            dom.fileUpload.addEventListener('drop', handleDrop);
            dom.fileInput.addEventListener('change', handleFileSelect);
            dom.artworkInput.addEventListener('change', handleArtworkSelect);
            dom.removeArtworkBtn.addEventListener('click', removeArtwork);
            dom.reloadMetadataBtn.addEventListener('click', reloadMetadata);
            dom.saveMetadataBtn.addEventListener('click', saveMetadata);
            dom.clearAllBtn.addEventListener('click', () => {
                showConfirmationModal(
                    'Clear All Fields?',
                    'Are you sure you want to clear all metadata fields? This action cannot be undone.',
                    clearAllFields
                );
            });
            dom.modalCancelBtn.addEventListener('click', hideConfirmationModal);
        }

        // --- File Handling ---
        function handleDragOver(e) { e.preventDefault(); dom.fileUpload.classList.add('drag-over'); }
        function handleDragLeave(e) { e.preventDefault(); dom.fileUpload.classList.remove('drag-over'); }
        
        function handleDrop(e) {
            e.preventDefault();
            dom.fileUpload.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'audio/mpeg') {
                handleFile(file);
            } else {
                showStatus('Please drop an MP3 file.', 'error');
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) handleFile(file);
        }

        function handleFile(file) {
            state.currentFile = file;
            state.currentArtworkFile = null;
            showFileInfo(file);
            loadMetadataFromFile(file);
            dom.editorSection.classList.remove('hidden');
            dom.fileUpload.classList.add('hidden');
            showStatus('File loaded. You can now edit the metadata.', 'success');
        }

        function showFileInfo(file) {
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            dom.fileInfo.innerHTML = `
                <p class="font-semibold text-white"><strong>File:</strong> ${file.name}</p>
                <p class="text-sm text-slate-400"><strong>Size:</strong> ${fileSize} MB | <strong>Type:</strong> ${file.type}</p>
            `;
        }

        // --- Metadata Reading (jsmediatags) ---
        function loadMetadataFromFile(file) {
            clearAllFields();
            showStatus('Reading metadata...', 'warning');
            window.jsmediatags.read(file, {
                onSuccess: (tag) => {
                    const tags = tag.tags;
                    state.originalMetadata = {
                        title: tags.title || '',
                        artist: tags.artist || '',
                        album: tags.album || '',
                        albumArtist: tags.TPE2?.data || '',
                        year: tags.year || '',
                        track: tags.track || '',
                        genre: tags.genre || '',
                        composer: tags.TCOM?.data || '',
                        comment: tags.comment?.text || '',
                        picture: tags.picture || null
                    };
                    populateForm(state.originalMetadata);
                    showStatus('Metadata loaded successfully.', 'success');
                },
                onError: (error) => {
                    console.error('Error reading metadata:', error);
                    showStatus('Could not read metadata. You can add it manually.', 'error');
                    state.originalMetadata = {}; // Reset on error
                    populateForm({});
                }
            });
        }

        function populateForm(metadata) {
            dom.fields.title.value = metadata.title || '';
            dom.fields.artist.value = metadata.artist || '';
            dom.fields.album.value = metadata.album || '';
            dom.fields.albumArtist.value = metadata.albumArtist || '';
            dom.fields.year.value = metadata.year || '';
            dom.fields.track.value = metadata.track || '';
            dom.fields.genre.value = metadata.genre || '';
            dom.fields.composer.value = metadata.composer || '';
            dom.fields.comment.value = metadata.comment || '';
            
            if (metadata.picture) {
                displayArtworkFromTag(metadata.picture);
            } else {
                removeArtwork();
            }
        }

        // --- Artwork Handling ---
        function handleArtworkSelect(e) {
            const file = e.target.files[0];
            if (file && (file.type === 'image/jpeg' || file.type === 'image/png')) {
                state.currentArtworkFile = file;
                displayArtworkFromFile(file);
                showStatus('New artwork selected. Remember to save.', 'success');
            } else {
                showStatus('Please select a JPEG or PNG image.', 'error');
            }
        }
        
        function displayArtworkFromTag(picture) {
            const blob = new Blob([new Uint8Array(picture.data)], { type: picture.format });
            const reader = new FileReader();
            reader.onload = (e) => {
                dom.artworkPreview.innerHTML = `<img src="${e.target.result}" alt="Album Artwork" class="w-full h-full object-cover rounded-md">`;
                dom.artworkInfo.textContent = `Existing artwork loaded (${(blob.size / 1024).toFixed(1)} KB).`;
                dom.removeArtworkBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(blob);
        }

        function displayArtworkFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                dom.artworkPreview.innerHTML = `<img src="${e.target.result}" alt="New Album Artwork" class="w-full h-full object-cover rounded-md">`;
                dom.artworkInfo.textContent = `New artwork: ${file.name} (${(file.size / 1024).toFixed(1)} KB).`;
                dom.removeArtworkBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function removeArtwork() {
            dom.artworkPreview.innerHTML = `<svg class="w-12 h-12 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>`;
            dom.artworkInfo.textContent = 'No artwork loaded.';
            dom.artworkInput.value = '';
            state.currentArtworkFile = null;
            state.originalMetadata.picture = null; // Mark original artwork as removed
            dom.removeArtworkBtn.classList.add('hidden');
        }

        // --- Core Actions ---
        function clearAllFields() {
            Object.values(dom.fields).forEach(field => field.value = '');
            removeArtwork();
            showStatus('All fields cleared.', 'warning');
        }
        
        function reloadMetadata() {
            if (state.currentFile) {
                populateForm(state.originalMetadata);
                state.currentArtworkFile = null; // Reset any newly selected artwork
                showStatus('Original metadata reloaded.', 'success');
            }
        }

        async function saveMetadata() {
            if (!state.currentFile) {
                showStatus('No file loaded.', 'error');
                return;
            }
            
            dom.loadingOverlay.classList.remove('hidden');
            showStatus('Preparing to save...', 'warning');

            try {
                const songBuffer = await readFileAsArrayBuffer(state.currentFile);
                const writer = new ID3Writer(songBuffer);

                // Set text frames
                writer.setFrame('TIT2', dom.fields.title.value)
                      .setFrame('TPE1', [dom.fields.artist.value])
                      .setFrame('TALB', dom.fields.album.value)
                      .setFrame('TPE2', dom.fields.albumArtist.value)
                      .setFrame('TYER', dom.fields.year.value)
                      .setFrame('TRCK', dom.fields.track.value)
                      .setFrame('TCON', [dom.fields.genre.value])
                      .setFrame('TCOM', [dom.fields.composer.value])
                      .setFrame('COMM', { description: '', text: dom.fields.comment.value, language: 'eng' });

                // Handle artwork
                if (state.currentArtworkFile) {
                    const artworkBuffer = await readFileAsArrayBuffer(state.currentArtworkFile);
                    writer.setFrame('APIC', {
                        type: 3,
                        data: artworkBuffer,
                        description: 'Cover'
                    });
                } else if (!state.originalMetadata.picture) {
                    writer.removeFrame('APIC');
                }

                writer.addTag();
                const taggedSongBlob = writer.getBlob();
                const taggedSongUrl = writer.getURL();

                // Trigger download
                const link = document.createElement('a');
                link.href = taggedSongUrl;
                link.download = state.currentFile.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('File saved successfully!', 'success');
                
                // Refresh the UI with the new file data
                const newFile = new File([taggedSongBlob], state.currentFile.name, {type: 'audio/mpeg', lastModified: Date.now()});
                handleFile(newFile);

            } catch (error) {
                console.error('Error saving metadata:', error);
                showStatus('Failed to save metadata. See console for details.', 'error');
            } finally {
                dom.loadingOverlay.classList.add('hidden');
            }
        }

        // --- Utility & UI Functions ---
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        }

        function showStatus(message, type = 'success') {
            const colors = {
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            dom.statusMessage.innerHTML = `<p class="${colors[type]}">${message}</p>`;
        }

        function showConfirmationModal(title, message, onConfirm) {
            dom.modalTitle.textContent = title;
            dom.modalMessage.textContent = message;
            dom.confirmModal.classList.remove('hidden');
            
            // Clone and replace the confirm button to remove old event listeners
            const newConfirmBtn = dom.modalConfirmBtn.cloneNode(true);
            dom.modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, dom.modalConfirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                hideConfirmationModal();
            });
            // Re-assign the DOM reference
            dom.modalConfirmBtn = newConfirmBtn;
        }

        function hideConfirmationModal() {
            dom.confirmModal.classList.add('hidden');
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', setupEventListeners);

    </script>
</body>
</html>
